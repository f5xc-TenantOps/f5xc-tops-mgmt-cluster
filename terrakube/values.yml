---
global:
  name: terrakube
  security:
    allowInsecureImages: true

security:
  # Disable OpenLDAP - using GitHub OAuth instead
  useOpenLDAP: false
  # Map GitHub team to admin group: f5xc-TenantOps:tenantops-admin
  adminGroup: "f5xc-TenantOps:tenantops-admin"
  dexClientId: "terrakube"
  dexClientScope: "email openid profile offline_access groups"
  dexIssuerUri: "https://terrakube-api.tops.k11s.io/dex"

api:
  existingSecret: false
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "2000m"
      memory: "2Gi"

ingress:
  useTls: true
  ui:
    enabled: true
    domain: "terrakube.tops.k11s.io"
    ingressClassName: "nginx"
  api:
    enabled: true
    domain: "terrakube-api.tops.k11s.io"
    ingressClassName: "nginx"
  registry:
    enabled: true
    domain: "terrakube-registry.tops.k11s.io"
    ingressClassName: "nginx"
  dex:
    enabled: true
    domain: "terrakube-dex.tops.k11s.io"
    ingressClassName: "nginx"

storage:
  defaultStorage: true

postgresql:
  enabled: true
  image:
    registry: docker.io
    repository: bitnamilegacy/postgresql
    tag: latest
  primary:
    resources:
      requests:
        cpu: "250m"
        memory: "512Mi"
      limits:
        cpu: "1000m"
        memory: "1Gi"

redis:
  enabled: true
  image:
    registry: docker.io
    repository: bitnamilegacy/redis
    tag: latest

minio:
  image:
    registry: docker.io
    repository: bitnamilegacy/minio
    tag: latest
  clientImage:
    registry: docker.io
    repository: bitnamilegacy/minio-client
    tag: latest

## OpenLDAP disabled - using GitHub OAuth
# openldap:
#   image: "bitnamilegacy/openldap"
#   version: "latest"

dex:
  # Inject GitHub OAuth credentials from Kubernetes secret as environment variables
  # Dex will expand $GITHUB_CLIENT_ID and $GITHUB_CLIENT_SECRET in connector config
  envFrom:
    - secretRef:
        name: terrakube-github-oauth
  config:
    issuer: https://terrakube-api.tops.k11s.io/dex
    storage:
      type: memory
    web:
      http: 0.0.0.0:5556
      allowedOrigins: ["*"]
      skipApprovalScreen: true
    oauth2:
      responseTypes: ["code", "token", "id_token"]
    connectors:
    - type: github
      id: github
      name: GitHub
      config:
        # Client credentials from terrakube-github-oauth secret
        clientID: $GITHUB_CLIENT_ID
        clientSecret: $GITHUB_CLIENT_SECRET
        redirectURI: https://terrakube-api.tops.k11s.io/dex/callback
        # Restrict to f5xc-TenantOps org members only
        orgs:
        - name: f5xc-TenantOps
          teams:
          - tenantops-admin
          - tenantops-ro
        # Load all groups for team-based permissions
        loadAllGroups: false
        # Use slug format for team names (lowercase with hyphens)
        teamNameField: slug
        useLoginAsID: false
    staticClients:
    - id: terrakube
      redirectURIs:
      - "https://terrakube.tops.k11s.io"
      - "/device/callback"
      - "http://localhost:10000/login"
      - "http://localhost:10001/login"
      name: "terrakube"
      public: true
